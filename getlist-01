import requests
from requests.auth import HTTPBasicAuth
import os
import urllib3

# === Disable SSL Warnings (for verify=False) ===
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# === Configuration ===

# --- Cloud Azure DevOps ---
cloud_org = "your-cloud-org"  # Example: CloudSteer
cloud_user_email = "user@domain.com"
cloud_pat = "your-cloud-pat"

# --- On-Prem Azure DevOps ---
onprem_base_url = "https://ado.global.test.com"
onprem_project_path = "sc-ado-ga-op/a2676d24-f5cf-423f-9277-e18efla2c8la"
onprem_api = f"{onprem_base_url}/{onprem_project_path}/_api_identity_/readsvopeApplicationGroupJson?__v=5"
onprem_pat = "your-onprem-pat"

# --- Auth Setup ---
cloud_auth = HTTPBasicAuth("", cloud_pat)
onprem_auth = HTTPBasicAuth("", onprem_pat)

# --- Proxy for on-prem only ---
onprem_proxies = {
    "http": "http://proxy-host:port",
    "https": "http://proxy-host:port"
}

# Optional: bypass proxy for internal on-prem server
os.environ["NO_PROXY"] = "ado.global.test.com"

# --- Headers ---
headers = {"Content-Type": "application/json"}

# === Step 1: Get cloud user descriptor ===
print(f"🔍 Fetching user descriptor for: {cloud_user_email}")
identity_url = f"https://vssps.dev.azure.com/{cloud_org}/_apis/identities?searchFilter=General&filterValue={cloud_user_email}&queryMembership=Direct&api-version=7.1"

try:
    resp = requests.get(identity_url, headers=headers, auth=cloud_auth, verify=False)
except requests.exceptions.RequestException as e:
    print("❌ Error while accessing Azure DevOps Cloud.")
    print(e)
    exit()

if resp.status_code != 200:
    print(f"❌ Failed to fetch cloud user identity: {resp.status_code}")
    exit()

identity_info = resp.json()
if identity_info["count"] == 0:
    print("❌ User not found in cloud.")
    exit()

user_descriptor = identity_info["value"][0]["descriptor"]
member_of = identity_info["value"][0].get("memberOf", [])

print(f"\n👤 Cloud user is part of {len(member_of)} groups.")
cloud_group_names = []

for group_descriptor in member_of:
    group_url = f"https://vssps.dev.azure.com/{cloud_org}/_apis/identities/{group_descriptor}?api-version=7.1"
    group_resp = requests.get(group_url, headers=headers, auth=cloud_auth, verify=False)
    if group_resp.status_code == 200:
        group_name = group_resp.json().get("providerDisplayName", "Unknown")
        cloud_group_names.append(group_name)
        print(f"✔️ {group_name}")
    else:
        print(f"⚠️ Could not fetch group name for descriptor: {group_descriptor}")

# === Step 2: Get on-prem groups ===
print("\n📡 Fetching on-prem group identities...")

try:
    onprem_resp = requests.get(onprem_api, headers=headers, auth=onprem_auth, verify=False, proxies=onprem_proxies)
except requests.exceptions.RequestException as e:
    print("❌ Error while accessing Azure DevOps Server.")
    print(e)
    exit()

if onprem_resp.status_code != 200:
    print(f"❌ Failed to fetch on-prem groups: {onprem_resp.status_code}")
    exit()

onprem_groups = onprem_resp.json().get("Identities", [])
print(f"✅ Retrieved {len(onprem_groups)} groups from on-prem.")

# === Step 3: Match cloud groups to on-prem ===
print("\n🔗 Matching cloud groups to on-prem...\n")
matched = []

for cloud_group in cloud_group_names:
    match = next((g for g in onprem_groups if g.get("FriendlyDisplayName", "").lower() == cloud_group.lower()), None)
    if match:
        print(f"✅ Matched: {cloud_group} → {match['Descriptor']}")
        matched.append({
            "name": cloud_group,
            "onprem_descriptor": match["Descriptor"],
            "onprem_id": match["TeamFoundationId"]
        })
    else:
        print(f"❌ No match found for: {cloud_group}")

# === Summary ===
print("\n📋 Final Mapped Group Results:")
for m in matched:
    print(f"- {m['name']} => {m['onprem_descriptor']}")
